{% extends "base.html" %}

{% block title %}Preview - {{ book.child_name }}{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-5xl">
        
        <!-- Loading State -->
        <div id="loading" class="bg-white rounded-2xl shadow-xl p-12 text-center">
            <div class="flex justify-center mb-6">
                <div class="animate-spin rounded-full h-20 w-20 border-b-4 border-purple-600"></div>
            </div>
            <h2 id="loadingTitle" class="text-3xl font-bold text-gray-800 mb-4">Creando tu libro...</h2>
            <p id="loadingStep" class="text-xl text-gray-600 mb-6">Preparando...</p>
            
            <!-- Progress Bar -->
            <div class="max-w-md mx-auto">
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-500 mt-2">0%</p>
            </div>

            <div class="mt-8 space-y-2 text-left max-w-md mx-auto bg-gray-50 rounded-lg p-4">
                <div id="step1" class="flex items-center text-gray-400">
                    <span class="mr-2">‚è≥</span> Creando idea del cuento
                </div>
                <div id="step2" class="flex items-center text-gray-400">
                    <span class="mr-2">‚è≥</span> Transformando en portada m√°gica
                </div>
            </div>
        </div>

        <!-- Content (hidden initially) -->
        <div id="content" class="hidden">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                    üìñ Preview de tu Libro
                </h1>
                <p class="text-gray-600">Para: <span class="font-semibold">{{ book.child_name }}</span> ({{ book.child_age }} a√±os)</p>
            </div>

            <!-- Main Content -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                
                <!-- Cover -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">‚ú® Portada</h2>
                    <div id="coverContainer" class="bg-gray-100 rounded-lg overflow-hidden aspect-square flex items-center justify-center">
                        {% if cover_url %}
                            <img src="{{ cover_url }}" alt="Portada" class="w-full h-full object-cover">
                        {% else %}
                            <p class="text-gray-400">Cargando portada...</p>
                        {% endif %}
                    </div>
                    
                    <!-- Regenerate Button -->
                    <div id="regenerateSection" class="mt-4">
                        <button 
                            id="regenerateBtn"
                            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg transition shadow"
                        >
                            üîÑ No me gusta, generar otra portada
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Puedes regenerar hasta 3 veces por d√≠a</p>
                    </div>
                </div>

                <!-- Details -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìö Detalles</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-500">T√≠tulo</p>
                            <p id="bookTitle" class="text-lg font-semibold text-gray-800">{{ story_data.titulo or 'Cargando...' }}</p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-500">Tema</p>
                            <p id="bookTheme" class="text-lg font-semibold text-gray-800">{{ story_data.tema or 'Aventura' }}</p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-500">P√°ginas ilustradas</p>
                            <p class="text-lg font-semibold text-gray-800">12 p√°ginas</p>
                        </div>
                        
                        <div id="storyPreview">
                            <p class="text-sm text-gray-500">Resumen</p>
                            <p id="storyPreviewText" class="text-gray-700">{{ story_data.resumen or 'Cargando...' }}</p>
                        </div>
                    </div>

                    <hr class="my-6">

                    <!-- Pricing -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6">
                        <p class="text-sm text-gray-600 mb-2">Precio del libro completo</p>
                        <p class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-4">
                            {{ book.total_price_euros }}‚Ç¨
                        </p>
                        <ul class="text-sm text-gray-600 space-y-1 mb-6">
                            <li>‚úÖ 12 p√°ginas ilustradas personalizadas</li>
                            <li>‚úÖ Historia √∫nica con IA</li>
                            <li>‚úÖ PDF de alta calidad</li>
                            <li>‚úÖ Listo para imprimir</li>
                        </ul>
                        
                        <a 
                            href="/checkout/{{ book.id }}" 
                            id="buyButton"
                            class="block w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg text-center transform hover:scale-105 duration-200"
                        >
                            üí≥ Comprar Libro Completo
                        </a>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-8">
                <h3 class="text-red-800 font-bold mb-2">‚ùå Error</h3>
                <p id="errorText" class="text-red-700"></p>
            </div>

        </div>
    </div>
</div>

<script>
    const bookId = '{{ book.id }}';
    const initialStatus = '{{ book.status }}';
    let pollingInterval = null;

    async function checkStatus() {
        try {
            const response = await fetch(`/api/books/${bookId}/status`);
            const data = await response.json();
            
            // Update step visualization
            updateStepProgress(data.current_step, data.progress_percentage);
            
            if (data.status === 'preview_ready') {
                clearInterval(pollingInterval);
                showContent(data);
            } else if (data.status === 'preview_error') {
                clearInterval(pollingInterval);
                showError(data.error);
            }
            
        } catch (error) {
            console.error('Error checking status:', error);
        }
    }

    function updateStepProgress(currentStep, progress) {
        // Update progress bar
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = Math.round(progress) + '%';
        
        // Update step text
        if (currentStep) {
            document.getElementById('loadingStep').textContent = currentStep;
        }
        
        // Update step checkmarks (SOLO 2 PASOS AHORA)
        const stepMapping = {
            'Creando': 'step1',
            'idea': 'step1',
            'cuento': 'step1',
            'Transformando': 'step2',
            'portada': 'step2',
            'm√°gica': 'step2'
        };
        
        for (const [text, stepId] of Object.entries(stepMapping)) {
            const el = document.getElementById(stepId);
            if (!el) continue;
            
            if (currentStep && currentStep.toLowerCase().includes(text.toLowerCase())) {
                el.className = 'flex items-center text-blue-600 font-semibold';
                el.querySelector('span').textContent = 'üîÑ';
            } else if (progress > getStepProgress(stepId)) {
                el.className = 'flex items-center text-green-600';
                el.querySelector('span').textContent = '‚úÖ';
            }
        }
    }

    function getStepProgress(stepId) {
        const progressMap = {
            'step1': 20,
            'step2': 60
        };
        return progressMap[stepId] || 0;
    }

    function showContent(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        
        // Update cover if available
        if (data.cover_preview_url) {
            document.getElementById('coverContainer').innerHTML = 
                `<img src="${data.cover_preview_url}" alt="Portada" class="w-full h-full object-cover">`;
        }
        
        // Update story info (ARREGLADO: ahora s√≠ actualiza)
        if (data.title) {
            document.getElementById('bookTitle').textContent = data.title;
        }
        
        if (data.story_preview) {
            document.getElementById('storyPreviewText').textContent = data.story_preview;
            document.getElementById('storyPreview').classList.remove('hidden');
        }
    }

    function showError(error) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        document.getElementById('errorMessage').classList.remove('hidden');
        document.getElementById('errorText').textContent = error || 'Error desconocido';
        document.getElementById('buyButton').classList.add('hidden');
    }

    // Regenerate cover
    document.getElementById('regenerateBtn')?.addEventListener('click', async function() {
        if (!confirm('¬øQuieres regenerar la portada? Esto puede tardar 1 minuto.')) return;
        
        this.disabled = true;
        this.innerHTML = '‚è≥ Regenerando...';
        
        try {
            const response = await fetch(`/api/books/${bookId}/regenerate-preview`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Show loading and start polling
                document.getElementById('content').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loadingTitle').textContent = 'Regenerando portada...';
                pollingInterval = setInterval(checkStatus, 2000);
            } else {
                alert('‚ùå ' + data.detail);
                this.disabled = false;
                this.innerHTML = 'üîÑ No me gusta, generar otra portada';
            }
        } catch (err) {
            alert('‚ùå Error: ' + err.message);
            this.disabled = false;
            this.innerHTML = 'üîÑ No me gusta, generar otra portada';
        }
    });

    // Initialize
    if (initialStatus === 'preview' || initialStatus === 'generating_story' || 
        initialStatus === 'generating_cover') {
        pollingInterval = setInterval(checkStatus, 2000);
        checkStatus();
    } else if (initialStatus === 'preview_ready') {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
    }
</script>
{% endblock %}