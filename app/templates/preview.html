{% extends "base.html" %}
{% block title %}Preview - {{ book.child_name }}{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; scroll-behavior: smooth; background-color: #f9fafb; background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px); background-size: 15px 15px; }
  .blob { position: absolute; border-radius: 50%; filter: blur(80px); z-index: 0; }
</style>

<body class="relative overflow-x-hidden">

<div class="relative bg-indigo-50/80 backdrop-blur-sm overflow-hidden py-8 sm:py-12">
  <div class="blob w-96 h-96 bg-indigo-200 -top-20 -left-20"></div>
  <div class="blob w-72 h-72 bg-purple-200 -bottom-20 -right-10"></div>
  
  <div class="container relative mx-auto max-w-6xl px-6 z-10">
    
    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-2xl shadow-xl p-8 sm:p-12 text-center">
      <div class="flex justify-center mb-6">
        <div class="animate-spin rounded-full h-16 sm:h-20 w-16 sm:w-20 border-b-4 border-indigo-600"></div>
      </div>
      <h2 id="loadingTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Creando tu libro...</h2>
      <p id="loadingStep" class="text-lg sm:text-xl text-gray-600 mb-6">Preparando...</p>
      
      <!-- Progress Bar -->
      <div class="max-w-md mx-auto">
        <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
          <div id="progressBar" class="bg-gradient-to-r from-indigo-600 to-purple-600 h-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-500 mt-2">0%</p>
      </div>

      <div class="mt-8 space-y-2 text-left max-w-md mx-auto bg-gray-50 rounded-lg p-4">
        <div id="step1" class="flex items-center text-gray-400">
          <span class="mr-2">‚è≥</span> Generando historia personalizada
        </div>
        <div id="step2" class="flex items-center text-gray-400">
          <span class="mr-2">‚è≥</span> Creando personajes √∫nicos
        </div>
        <div id="step3" class="flex items-center text-gray-400">
          <span class="mr-2">‚è≥</span> Dise√±ando escenarios m√°gicos
        </div>
        <div id="step4" class="flex items-center text-gray-400">
          <span class="mr-2">‚è≥</span> Generando portada
        </div>
      </div>
    </div>

    <!-- Content (hidden initially) -->
    <div id="content" class="hidden">
      
      <!-- Header -->
      <div class="text-center mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-900 mb-2">
          üìñ Preview de tu Libro
        </h1>
        <p class="text-gray-700">Para: <span class="font-semibold text-indigo-700">{{ book.child_name }}</span> ({{ book.child_age }} a√±os)</p>
      </div>

      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8">
        
        <!-- Cover -->
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">‚ú® Portada</h2>
          <div id="coverContainer" class="bg-gray-100 rounded-lg overflow-hidden aspect-square flex items-center justify-center">
            {% if cover_url %}
              <img src="{{ cover_url }}" alt="Portada" class="w-full h-full object-cover">
            {% else %}
              <p class="text-gray-400">Cargando portada...</p>
            {% endif %}
          </div>
          
          <!-- Regenerate Button -->
          <div id="regenerateSection" class="mt-4">
            <button 
              id="regenerateBtn"
              class="w-full bg-amber-500 hover:bg-amber-600 text-indigo-900 font-bold py-3 px-4 rounded-lg transition shadow transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-300"
            >
              üîÑ No me gusta, generar otra portada
            </button>
            <p class="text-xs text-gray-500 mt-2 text-center">Puedes regenerar hasta 3 veces por d√≠a</p>
          </div>
        </div>

        <!-- Details -->
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">üìö Detalles</h2>
          
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-500">T√≠tulo</p>
              <p id="bookTitle" class="text-lg font-semibold text-gray-800">{{ story_data.titulo or 'Cargando...' }}</p>
            </div>
            
            <div>
              <p class="text-sm text-gray-500">Tema</p>
              <p id="bookTheme" class="text-lg font-semibold text-gray-800">{{ story_data.tema or 'Aventura' }}</p>
            </div>
            
            <div>
              <p class="text-sm text-gray-500">P√°ginas ilustradas</p>
              <p class="text-lg font-semibold text-gray-800">12 p√°ginas</p>
            </div>
            
            <div id="storyPreview" class="{% if not story_data.resumen %}hidden{% endif %}">
              <p class="text-sm text-gray-500">Resumen</p>
              <p class="text-gray-700">{{ story_data.resumen or '' }}</p>
            </div>
          </div>

          <hr class="my-6">

          <!-- Pricing -->
          <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
            <p class="text-sm text-gray-600 mb-2">Precio del libro completo</p>
            <p class="text-3xl sm:text-4xl font-bold text-indigo-600 mb-4">
              {{ book.total_price_euros }}‚Ç¨
            </p>
            <ul class="text-sm text-gray-600 space-y-1 mb-6">
              <li>‚úÖ 12 p√°ginas ilustradas personalizadas</li>
              <li>‚úÖ Historia √∫nica con IA</li>
              <li>‚úÖ PDF de alta calidad</li>
              <li>‚úÖ Listo para imprimir</li>
            </ul>
            
            <a 
              href="/checkout/{{ book.id }}" 
              id="buyButton"
              class="block w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg text-center transform hover:scale-105 duration-200"
            >
              üí≥ Comprar Libro Completo
            </a>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-8">
        <h3 class="text-red-800 font-bold mb-2">‚ùå Error</h3>
        <p id="errorText" class="text-red-700"></p>
      </div>

    </div>
  </div>
</div>

<script>
  const bookId = '{{ book.id }}';
  const initialStatus = '{{ book.status }}';
  let pollingInterval = null;

  async function checkStatus() {
    try {
      const response = await fetch(`/api/books/${bookId}/status`);
      const data = await response.json();
      
      updateStepProgress(data.current_step, data.progress_percentage);
      
      if (data.status === 'preview_ready') {
        clearInterval(pollingInterval);
        showContent(data);
      } else if (data.status === 'preview_error') {
        clearInterval(pollingInterval);
        showError(data.error);
      }
      
    } catch (error) {
      console.error('Error checking status:', error);
    }
  }

  function updateStepProgress(currentStep, progress) {
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = Math.round(progress) + '%';
    
    if (currentStep) {
      document.getElementById('loadingStep').textContent = currentStep;
    }
    
    const stepMapping = {
      'Generando historia': 'step1',
      'Creando character sheet': 'step2',
      'Creando scene sheet': 'step3',
      'Generando portada': 'step4'
    };
    
    for (const [text, stepId] of Object.entries(stepMapping)) {
      const el = document.getElementById(stepId);
      if (currentStep && currentStep.includes(text.split(' ')[1])) {
        el.className = 'flex items-center text-indigo-600 font-semibold';
        el.querySelector('span').textContent = 'üîÑ';
      } else if (progress > getStepProgress(stepId)) {
        el.className = 'flex items-center text-green-600';
        el.querySelector('span').textContent = '‚úÖ';
      }
    }
  }

  function getStepProgress(stepId) {
    const progressMap = {
      'step1': 25,
      'step2': 50,
      'step3': 75,
      'step4': 90
    };
    return progressMap[stepId] || 0;
  }

  function showContent(data) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    
    if (data.cover_preview_url) {
      document.getElementById('coverContainer').innerHTML = 
        `<img src="${data.cover_preview_url}" alt="Portada" class="w-full h-full object-cover">`;
    }
    
    if (data.story_preview) {
      document.getElementById('storyPreview').classList.remove('hidden');
    }
  }

  function showError(error) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('errorMessage').classList.remove('hidden');
    document.getElementById('errorText').textContent = error || 'Error desconocido';
    document.getElementById('buyButton').classList.add('hidden');
  }

  // Regenerate cover
  document.getElementById('regenerateBtn')?.addEventListener('click', async function() {
    if (!confirm('¬øQuieres regenerar la portada? Esto puede tardar 1 minuto.')) return;
    
    this.disabled = true;
    this.innerHTML = '‚è≥ Regenerando...';
    
    try {
      const response = await fetch(`/api/books/${bookId}/regenerate-preview`, {
        method: 'POST'
      });
      
      const data = await response.json();
      
      if (response.ok) {
        document.getElementById('content').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loadingTitle').textContent = 'Regenerando portada...';
        pollingInterval = setInterval(checkStatus, 2000);
      } else {
        alert('‚ùå ' + data.detail);
        this.disabled = false;
        this.innerHTML = 'üîÑ No me gusta, generar otra portada';
      }
    } catch (err) {
      alert('‚ùå Error: ' + err.message);
      this.disabled = false;
      this.innerHTML = 'üîÑ No me gusta, generar otra portada';
    }
  });

  // Initialize
  if (initialStatus === 'preview' || initialStatus === 'generating_story' || 
      initialStatus === 'generating_character_sheet' || initialStatus === 'generating_scene_sheet' ||
      initialStatus === 'generating_cover') {
    pollingInterval = setInterval(checkStatus, 2000);
    checkStatus();
  } else if (initialStatus === 'preview_ready') {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
  }
</script>

</body>
{% endblock %}