{% extends "base.html" %}
{% block content %}
<h1>ğŸ’³ Comprar: {{ story_data.titulo }}</h1>

<div style="display: flex; gap: 30px; margin: 20px 0;">
    <div style="flex: 1;">
        {% if cover_url %}
            <img src="{{ cover_url }}" alt="Portada" style="max-width: 100%; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        {% endif %}
    </div>
    
    <div style="flex: 1;">
        <h2>ğŸ“– Detalles del libro</h2>
        <p><strong>Para:</strong> {{ book.child_name }}</p>
        <p><strong>Edad:</strong> {{ book.child_age }} aÃ±os</p>
        <p><strong>PÃ¡ginas:</strong> {{ book.total_pages }}</p>
        <p><strong>Tema:</strong> {{ story_data.get('tema', 'Aventura') }}</p>
        
        <hr>
        
        <h3>ğŸ’° Precio</h3>
        <p style="font-size: 24px; font-weight: bold; color: #007bff;">
            {{ book.total_price_euros }}â‚¬
        </p>
        
        <p style="font-size: 14px; color: #666;">
            Precio base: {{ base_price }}â‚¬<br>
            {% if book.total_pages > default_pages %}
                PÃ¡ginas extra: {{ book.total_pages - default_pages }} x {{ price_per_extra_page }}â‚¬
            {% endif %}
        </p>
        
        <hr>
        
        <h3>ğŸ” Pago (Modo Debug)</h3>
        <form id="paymentForm" onsubmit="handlePayment(event)">
            <label>ContraseÃ±a de debug:</label>
            <input type="password" id="password" placeholder="Introduce contraseÃ±a" required style="width: 100%; padding: 10px; margin: 10px 0;">
            
            <button type="submit" style="width: 100%; padding: 15px; font-size: 18px; margin-top: 10px;">
                ğŸš€ Comprar y Generar Libro Completo
            </button>
        </form>
        
        <div id="message" style="margin-top: 20px; padding: 15px; border-radius: 5px; display: none;"></div>
    </div>
</div>

<script>
async function handlePayment(event) {
    event.preventDefault();
    
    const password = document.getElementById('password').value;
    const messageDiv = document.getElementById('message');
    const submitBtn = event.target.querySelector('button');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ Procesando...';
    
    try {
        const response = await fetch('/api/books/{{ book.id }}/simulate-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.innerHTML = `
                <strong>âœ… Â¡Pago simulado exitoso!</strong><br>
                Tu libro se estÃ¡ generando. Esto puede tardar varios minutos.<br>
                <a href="/book/${data.book_id}" style="color: #155724; text-decoration: underline;">Ver estado del libro</a>
            `;
            
            // Redirigir despuÃ©s de 3 segundos
            setTimeout(() => {
                window.location.href = '/book/{{ book.id }}';
            }, 3000);
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = 'âŒ Error: ' + (data.detail || 'ContraseÃ±a incorrecta');
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸš€ Comprar y Generar Libro Completo';
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.backgroundColor = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'âŒ Error de conexiÃ³n: ' + error.message;
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ Comprar y Generar Libro Completo';
    }
}
</script>
{% endblock %}