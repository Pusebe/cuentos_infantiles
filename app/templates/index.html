{% extends "base.html" %}
{% block content %}
<h1>Generador de Libros Infantiles V2</h1>
<p><strong>OpenAI configurada:</strong> {{ gemini_configured }}</p>
<p><strong>Precio base:</strong> {{ base_price }}€</p>
<p><strong>Libros creados:</strong> {{ stats.total_books }}</p>

<hr>

<h2>Crear Preview Gratuito</h2>
<form id="bookForm" method="post" action="/api/books/create-preview" enctype="multipart/form-data">
    <div>
        <label>Nombre del niño:</label>
        <input type="text" name="child_name" placeholder="Ej: María" required>
    </div>
    <br>
    <div>
        <label>Edad (1-12):</label>
        <input type="number" name="child_age" min="1" max="12" placeholder="5" required>
    </div>
    <br>
    <div>
        <label>Descripción (opcional):</label>
        <textarea name="child_description" placeholder="Le gustan los dinosaurios..."></textarea>
    </div>
    <br>
    <div>
        <label>Foto del niño:</label>
        <input type="file" name="photo" accept="image/*" required>
    </div>
    <br>
    <div>
        <label>Páginas del libro:</label>
        <input type="number" name="total_pages" min="4" max="20" value="6">
    </div>
    <br>
    <button type="submit" id="submitBtn">Crear Preview Gratuito</button>
</form>

<div id="loading" style="display: none; text-align: center; margin-top: 30px;">
    <div class="spinner"></div>
    <p>Creando tu preview...</p>
</div>

<style>
.spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #007bff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.getElementById('bookForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('submitBtn');
    const loadingDiv = document.getElementById('loading');
    
    // Deshabilitar botón y mostrar loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creando...';
    loadingDiv.style.display = 'block';
    
    try {
        const response = await fetch('/api/books/create-preview', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Redirigir directamente al preview
            window.location.href = '/preview/' + data.id;
        } else {
            alert('Error: ' + data.detail);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Crear Preview Gratuito';
            loadingDiv.style.display = 'none';
        }
    } catch (err) {
        alert('Error de conexión: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Preview Gratuito';
        loadingDiv.style.display = 'none';
        console.error(err);
    }
});
</script>
{% endblock %}