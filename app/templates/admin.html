{% extends "base.html" %}
{% block title %}Panel Admin - Regeneraciones{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; scroll-behavior: smooth; background-color: #f9fafb; background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px); background-size: 15px 15px; }
  .blob { position: absolute; border-radius: 50%; filter: blur(80px); z-index: 0; }
</style>

<body class="relative overflow-x-hidden">

<div class="relative bg-indigo-50/80 backdrop-blur-sm overflow-hidden py-8 sm:py-12">
  <div class="blob w-96 h-96 bg-indigo-200 -top-20 -left-20"></div>
  <div class="blob w-72 h-72 bg-purple-200 -bottom-20 -right-10"></div>
  
  <div class="container relative mx-auto max-w-6xl px-6 z-10">
    
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">üîê Panel de Administraci√≥n</h1>
      <p class="text-gray-600">Gesti√≥n de peticiones de regeneraci√≥n de p√°ginas</p>
    </div>

    <!-- Login (if not authenticated) -->
    <div id="loginSection" class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">Autenticaci√≥n</h2>
      <form id="loginForm" class="max-w-md">
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">
            Contrase√±a de Admin
          </label>
          <input 
            type="password" 
            id="adminPassword" 
            placeholder="Introduce contrase√±a" 
            required
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"
          >
        </div>
        <button 
          type="submit"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shadow transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300"
        >
          Acceder
        </button>
      </form>
      <div id="loginError" class="hidden mt-4 bg-red-50 border-2 border-red-200 rounded-lg p-4">
        <p class="text-red-800 font-semibold">‚ùå Contrase√±a incorrecta</p>
      </div>
    </div>

    <!-- Admin Panel (hidden until authenticated) -->
    <div id="adminPanel" class="hidden">
      
      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="text-3xl font-bold text-amber-600" id="pendingCount">0</div>
          <div class="text-gray-600 text-sm">Pendientes</div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="text-3xl font-bold text-emerald-600" id="approvedCount">0</div>
          <div class="text-gray-600 text-sm">Aprobadas</div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="text-3xl font-bold text-red-600" id="rejectedCount">0</div>
          <div class="text-gray-600 text-sm">Rechazadas</div>
        </div>
      </div>

      <!-- Requests Table -->
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üìã Peticiones Pendientes</h2>
          <button 
            onclick="loadRequests()"
            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm"
          >
            üîÑ Recargar
          </button>
        </div>

        <div id="loadingRequests" class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
          <p class="text-gray-600 mt-4">Cargando peticiones...</p>
        </div>

        <div id="noRequests" class="hidden text-center py-12">
          <div class="text-6xl mb-4">‚úÖ</div>
          <p class="text-xl text-gray-600">No hay peticiones pendientes</p>
        </div>

        <div id="requestsTable" class="hidden overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Libro</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ni√±o</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P√°gina</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raz√≥n</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="requestsBody" class="bg-white divide-y divide-gray-200">
              <!-- Rows will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  let adminPassword = '';

  // Login
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    adminPassword = document.getElementById('adminPassword').value;
    
    // Try to load requests to validate password
    const valid = await loadRequests();
    
    if (valid) {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
    } else {
      document.getElementById('loginError').classList.remove('hidden');
    }
  });

  async function loadRequests() {
    document.getElementById('loadingRequests').classList.remove('hidden');
    document.getElementById('noRequests').classList.add('hidden');
    document.getElementById('requestsTable').classList.add('hidden');
    
    try {
      const response = await fetch(`/api/admin/regeneration-requests?password=${encodeURIComponent(adminPassword)}`);
      
      if (!response.ok) {
        return false;
      }
      
      const requests = await response.json();
      
      document.getElementById('loadingRequests').classList.add('hidden');
      
      if (requests.length === 0) {
        document.getElementById('noRequests').classList.remove('hidden');
        document.getElementById('pendingCount').textContent = '0';
      } else {
        document.getElementById('requestsTable').classList.remove('hidden');
        document.getElementById('pendingCount').textContent = requests.length;
        renderRequests(requests);
      }
      
      return true;
      
    } catch (error) {
      console.error('Error loading requests:', error);
      document.getElementById('loadingRequests').classList.add('hidden');
      return false;
    }
  }

  function renderRequests(requests) {
    const tbody = document.getElementById('requestsBody');
    tbody.innerHTML = '';
    
    requests.forEach(req => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50';
      
      const date = new Date(req.created_at).toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      row.innerHTML = `
        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">#${req.id}</td>
        <td class="px-4 sm:px-6 py-4 text-sm text-gray-900">
          <div class="font-semibold">${req.book_title}</div>
          <div class="text-xs text-gray-500">${req.book_id.substring(0, 8)}...</div>
        </td>
        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${req.child_name}</td>
        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600">${req.page_number}</td>
        <td class="px-4 sm:px-6 py-4 text-sm text-gray-700 max-w-xs truncate">${req.reason || 'Sin raz√≥n'}</td>
        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
        <td class="px-4 sm:px-6 py-4 whitespace-nowrap text-sm space-x-2">
          <button 
            onclick="approveRequest(${req.id})"
            class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition text-xs"
          >
            ‚úÖ Aprobar
          </button>
          <button 
            onclick="rejectRequest(${req.id})"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition text-xs"
          >
            ‚ùå Rechazar
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  async function approveRequest(requestId) {
    if (!confirm('¬øAprobar esta regeneraci√≥n? Se regenerar√° la p√°gina y se recrear√° el PDF.')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/admin/regeneration/${requestId}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPassword })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        alert('‚úÖ Regeneraci√≥n aprobada y en proceso');
        loadRequests();
      } else {
        alert('‚ùå Error: ' + data.detail);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }

  async function rejectRequest(requestId) {
    if (!confirm('¬øRechazar esta regeneraci√≥n?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/admin/regeneration/${requestId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: adminPassword })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        alert('‚úÖ Regeneraci√≥n rechazada');
        loadRequests();
      } else {
        alert('‚ùå Error: ' + data.detail);
      }
    } catch (error) {
      alert('‚ùå Error: ' + error.message);
    }
  }
</script>

</body>
{% endblock %}