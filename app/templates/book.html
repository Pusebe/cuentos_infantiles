{% extends "base.html" %}
{% block title %}Libro - {{ book.child_name }}{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; scroll-behavior: smooth; background-color: #f9fafb; background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px); background-size: 15px 15px; }
  .blob { position: absolute; border-radius: 50%; filter: blur(80px); z-index: 0; }
</style>

<body class="relative overflow-x-hidden">

<div class="relative bg-indigo-50/80 backdrop-blur-sm overflow-hidden py-8 sm:py-12">
  <div class="blob w-96 h-96 bg-emerald-200 -top-20 -left-20"></div>
  <div class="blob w-72 h-72 bg-green-200 -bottom-20 -right-10"></div>
  
  <div class="container relative mx-auto max-w-6xl px-6 z-10">
    
    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-2xl shadow-xl p-8 sm:p-12 text-center">
      <div class="flex justify-center mb-6">
        <div class="animate-spin rounded-full h-20 sm:h-24 w-20 sm:w-24 border-b-4 border-emerald-600"></div>
      </div>
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">üé® Generando tu libro completo...</h2>
      <p id="loadingStep" class="text-lg sm:text-xl text-gray-600 mb-6">Preparando...</p>
      
      <!-- Progress Bar -->
      <div class="max-w-md mx-auto mb-6">
        <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
          <div id="progressBar" class="bg-gradient-to-r from-emerald-500 to-green-600 h-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-lg font-semibold text-gray-700 mt-2">0%</p>
      </div>

      <div class="text-gray-600">
        <p class="mb-2">‚è±Ô∏è Tiempo estimado: <span class="font-semibold">5-8 minutos</span></p>
        <p class="text-sm text-gray-500">Estamos creando 12 ilustraciones √∫nicas para tu libro</p>
      </div>
    </div>

    <!-- Content (hidden initially) -->
    <div id="content" class="hidden">
      
      <!-- Header -->
      <div class="text-center mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-emerald-700 mb-2">
          {{ story_data.titulo or "Libro de " + book.child_name }}
        </h1>
        <p class="text-gray-700">Para: <span class="font-semibold text-indigo-700">{{ book.child_name }}</span> ({{ book.child_age }} a√±os)</p>
        <div class="inline-block mt-4 px-4 py-2 bg-indigo-100 text-indigo-800 rounded-full text-sm font-semibold">
          Estado: <span id="statusBadge">{{ book.status }}</span>
        </div>
      </div>

      <!-- Download Section (shown when completed) -->
      <div id="downloadSection" class="bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-200 rounded-2xl p-6 sm:p-8 mb-8 hidden">
        <div class="text-center">
          <div class="text-5xl sm:text-6xl mb-4">üéâ</div>
          <h2 class="text-2xl sm:text-3xl font-bold text-emerald-800 mb-2">¬°Tu libro est√° listo!</h2>
          <p class="text-gray-700 mb-6">Ya puedes descargar tu libro personalizado en PDF</p>
          
          <a 
            id="pdfLink" 
            href="#" 
            download 
            class="inline-block bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-4 px-8 rounded-lg transition shadow-lg transform hover:scale-105 duration-200 text-lg"
          >
            üì• Descargar PDF
          </a>

          <p class="text-sm text-gray-600 mt-4">
            Incluye 14 p√°ginas: portada + 12 ilustradas + contraportada
          </p>
        </div>
      </div>

      <!-- Book Details -->
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl mb-8">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">üìñ Detalles del Libro</h2>
        
        <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
          <div>
            <p class="text-sm text-gray-500">Nombre</p>
            <p class="text-lg font-semibold text-gray-800">{{ book.child_name }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Edad</p>
            <p class="text-lg font-semibold text-gray-800">{{ book.child_age }} a√±os</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">P√°ginas</p>
            <p class="text-lg font-semibold text-gray-800">12 p√°ginas</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Precio</p>
            <p class="text-lg font-semibold text-gray-800">{{ book.total_price_euros }}‚Ç¨</p>
          </div>
        </div>
      </div>

      <!-- Regeneration Request Section (only when completed) -->
      <div id="regenerationSection" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl hidden">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">üîÑ ¬øNo te gusta alguna p√°gina?</h2>
        <p class="text-gray-600 mb-6">Puedes solicitar regenerar una p√°gina espec√≠fica. Revisaremos tu petici√≥n y la procesaremos.</p>
        
        <form id="regenerationForm" class="space-y-4">
          <div>
            <label class="block text-gray-700 font-semibold mb-2">
              N√∫mero de p√°gina (1-12)
            </label>
            <input 
              type="number" 
              id="pageNumber" 
              min="1" 
              max="12" 
              required
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition"
              placeholder="Ej: 5"
            >
          </div>
          
          <div>
            <label class="block text-gray-700 font-semibold mb-2">
              Raz√≥n (opcional)
            </label>
            <textarea 
              id="reason" 
              rows="3"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition resize-none"
              placeholder="Ej: La ilustraci√≥n no coincide con la historia..."
            ></textarea>
          </div>
          
          <button 
            type="submit"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition shadow transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300"
          >
            üì§ Enviar Solicitud
          </button>
        </form>

        <div id="regenerationSuccess" class="hidden mt-6 bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4">
          <p class="text-emerald-800 font-semibold">‚úÖ Solicitud enviada correctamente</p>
          <p class="text-emerald-700 text-sm">Tu solicitud ser√° revisada pronto.</p>
        </div>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <h3 class="text-red-800 font-bold mb-2">‚ùå Error</h3>
        <p id="errorText" class="text-red-700"></p>
      </div>

    </div>
  </div>
</div>

<script>
  const bookId = '{{ book.id }}';
  const initialStatus = '{{ book.status }}';
  const totalPages = {{ book.total_pages }};
  let pollingInterval = null;

  async function checkStatus() {
    try {
      const response = await fetch(`/api/books/${bookId}/status`);
      const data = await response.json();
      
      document.getElementById('statusBadge').textContent = data.status;
      
      if (data.current_step) {
        document.getElementById('loadingStep').textContent = data.current_step;
      }
      
      if (data.progress_percentage !== undefined) {
        const progress = Math.round(data.progress_percentage);
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = progress + '%';
      }
      
      if (data.status === 'paid' || data.status === 'generating') {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content').classList.add('hidden');
      }
      else if (data.status === 'completed') {
        clearInterval(pollingInterval);
        showCompleted(data);
      }
      else if (data.status === 'error') {
        clearInterval(pollingInterval);
        showError(data.error);
      }
      
    } catch (error) {
      console.error('Error checking status:', error);
    }
  }

  function showCompleted(data) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    
    if (data.pdf_url) {
      document.getElementById('downloadSection').classList.remove('hidden');
      document.getElementById('pdfLink').href = data.pdf_url;
    }
    
    document.getElementById('regenerationSection').classList.remove('hidden');
  }

  function showError(error) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('errorMessage').classList.remove('hidden');
    document.getElementById('errorText').textContent = error || 'Error desconocido';
  }

  // Regeneration form
  document.getElementById('regenerationForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const pageNumber = parseInt(document.getElementById('pageNumber').value);
    const reason = document.getElementById('reason').value;
    
    if (pageNumber < 1 || pageNumber > totalPages) {
      alert(`La p√°gina debe estar entre 1 y ${totalPages}`);
      return;
    }
    
    try {
      const response = await fetch(`/api/books/${bookId}/request-regeneration`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ page_number: pageNumber, reason: reason })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        document.getElementById('regenerationSuccess').classList.remove('hidden');
        document.getElementById('regenerationForm').reset();
        
        setTimeout(() => {
          document.getElementById('regenerationSuccess').classList.add('hidden');
        }, 5000);
      } else {
        alert('‚ùå ' + data.detail);
      }
    } catch (err) {
      alert('‚ùå Error: ' + err.message);
    }
  });

  // Initialize
  if (initialStatus === 'paid' || initialStatus === 'generating') {
    pollingInterval = setInterval(checkStatus, 3000);
    checkStatus();
  } else if (initialStatus === 'completed') {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    const pdfUrl = '{{ pdf_url }}';
    if (pdfUrl && pdfUrl !== 'None') {
      document.getElementById('downloadSection').classList.remove('hidden');
      document.getElementById('pdfLink').href = pdfUrl;
    }
    document.getElementById('regenerationSection').classList.remove('hidden');
  }
</script>

</body>
{% endblock %}